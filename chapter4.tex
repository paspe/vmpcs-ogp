\acresetall
\chapter{Evaluation}\label{ch:chapter4}

In this chapter, we present the evaluation of \emph{Ferify}. The first section includes the validation tests we performed. These tests represent the cases \emph{Ferify} can be employed. The next section covers the performance overhead tests we performed to evaluate the degree our solution impacts overall system usability.

\section{Validation}\label{sec:validation}

\par For the validation of \emph{Ferify}, we performed specific commands on the guest \ac{VM} in order to observe the behavior of the system and whether it conforms to the expectations. The commands reflect the cases that \emph{Ferify} can be applied. To do that we created an environmental setup to assess all the test cases. 

\par The configuration includes two users, \emph{alice} and \emph{bob}, both in the sudoers group, but \emph{bob} not legitimately, but through malicious actions. The intent is to check the detection of the illegal escalation of \emph{bob}'s account to \emph{root} and the effect it has.

\par Additionally we created a group that includes both users, with the intention to assess the per group policy enforcement to file access. 

\par Finally we will try, as \emph{root}, to access files that are being protected from root. These files include the \emph{/etc/shadow} file and the \emph{/etc/pam.d/su}, which are included in the \acp{SACL} to protect our initial \ac{VM} configuration.

\par These cases by themselves cover the basic set of actions that \emph{Ferify} was initially designed to monitor. Any combination of them is handled separately from the underlying \ac{OS}, reducing our problem to these elementary cases, making it easier to monitor and handle.

\subsection{Root escalation}

\par One of the first actions of an attacker or malicious program is to try to escalate its privileges to that of the root account. One of those techniques is to add the compromised user to the \emph{sudoers} group. To avoid such an exploitation, every time a trap gets caught by the hypervisor we check whether the user executing a \emph{sudo} command is actually allowed to, according to the initial administrative setup of \emph{Ferify} for the specific \ac{VM}. If the user is a legitimate \emph{sudoer} the flow of our plugin continues normally to check the validity of the file operation against the \acp{SACL}. On the other hand, if the user is not supposed to have \emph{sudo} privileges, the system calls, trapped by \emph{Ferify}, that get invoked get canceled, denying the ability to perform any \emph{sudo} command. Figure \ref{fig:sudo_deny} shows the result of trying to execute a \emph{sudo} command that gets denied, while at the same time we get notified on the hypervisor of the event as shown in fig. \ref{fig:sudo_deny_not}.

\begin{figure}[ht]
	\centering
	\footnotesize{\fontfamily{qcr}\selectfont 
		\begin{lstlisting}
bob@aHVM-domU:~$ sudo ls
sudo: unable to open /etc/sudoers: Bad address
sudo: no valid sudoers sources found, quitting
sudo: unable to initialize policy plugin
bob@aHVM-domU:~$
		\end{lstlisting}}
	\caption{Denying \emph{sudo}}
	\label{fig:sudo_deny}
\end{figure}

\begin{figure}[ht]
	\centering
	\footnotesize{\fontfamily{qcr}\selectfont 
		\begin{lstlisting}
Warning: Process root identity corruption detected in task 
	1377! Is 0 and should be 1002. Invalidating syscall.
[SYSCALL:   2] CR3:0x1afec000  , RDI: 0x7f2178a931f7 ,sudo 
	PID:1377 [0:1002] wants 0 access to file: 
	/etc/sudoers (mode:0)
		\end{lstlisting}}
	\caption{Denying \emph{sudo} notification on the hypervisor}
	\label{fig:sudo_deny_not}
\end{figure}

\par Having solved the issue of malicious root access, we then need to validate the expected behavior for file access, whether requested from the \emph{root} user or not.

\subsection{Group access}


\subsection{Root access}




\section{Performance overhead}\label{sec:performance}

In this section we present the performance overhead we observed on the guest \ac{OS} when running \emph{Ferify}. We performed time execution measurements in four stages. 

\par To have a baseline for comparison, we created a script which accesses a series of files, in order to trigger \emph{Ferify}, when it is running. Initially we timed the execution of the script over a number of iterations to extract an average time that we will use as a reference.

\subsection{Hypervisor - \ac{VM} switch}

\par One of the most intense operations in virtualization is the switch between the hypervisor and the \ac{VM}, as mentioned in subsection \ref{sub:invm}. \ac{CPU} virtualization extensions improve with every new model release, but this switch is still significant. To measure this overhead in performance, we ran \emph{Ferify} with empty \acp{SACL}. This way \emph{Ferify} traps the appropriate system calls and performs the switch between the \ac{VM} and the hypervisor. Because the \acp{SACL} are empty, there is insignificant computation performed while on the hypervisor, switching almost immediately back to the \ac{VM}. 


\subsection{Small \ac{SACL} performance overhead}

\par The information for the files stored in the \acp{SACL} is stored in an array of linked lists. The index of the array is the length of the pathname. Then all pathnames of the same length are stored in the same linked list. When only a few files are protected, these linked lists are very short, if not of size one or two. This makes the lookup process fast and easy. 

\subsection{Large \ac{SACL} performance overhead}

\par Adding more files to the \acp{SACL} may add a more substantial overhead. As shown in \ref{fig:pathname_length}, there is a significant amount of pathnames with lengths between 10 and 130. Having so many elements in a linked list introduces increased time in searching for a record. To assess the performance overhead we repeated the previous test, but this time after adding more than 1000 files in the \acp{SACL}. Writing \acp{ACL} for thousands of files is extremely time-consuming and error-prone. To automate this procedure we created a standalone script that pauses the guest \ac{VM}, mounts its filesystem to the hypervisor and starting from a specified mount-point, it returns the required information. 

\par After having generated a \ac{SACL} that corresponds to the current guest \ac{OS} filesystem permissions, the administrator can easily modify the permissions to reflect the desired policy to be enforced. 

\begin{figure}[ht]
	\centering
	\input{figs/graph1.tikz}
	\caption{Pathname length count}
	\label{fig:pathname_length}
\end{figure}


\subsection{Full \ac{OS} \ac{SACL} performance overhead}

\par Finally, we wanted to evaluate whether \emph{Ferify} can be used on the whole filesystem of a guest \ac{OS}. To do that we just created a \ac{SACL} that was generated by the aforementioned script when providing as mount-point the root folder of the guest \ac{OS}.




